<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Pedido - Panader√≠a</title>
  <style>
    :root { --color-amarillo: #F9D923; --color-azul: #0A2F66; --color-azul-claro: #E8F1FA; --color-hover: #FFD43B; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(to right, var(--color-azul-claro), #fff); margin: 0; padding: 0; color: var(--color-azul); }
    header { background-color: var(--color-azul); color: white; padding: 30px 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .card { background-color: white; max-width: 700px; margin: 40px auto; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 3px solid var(--color-amarillo); }
    input, textarea, select, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    button { background-color: var(--color-azul); color: white; font-weight: bold; border: none; cursor: pointer; margin-top: 25px; transition: all 0.3s ease; padding: 14px; font-size: 18px; }
    button:hover { background-color: var(--color-hover); color: var(--color-azul); transform: translateY(-2px); }
  </style>
</head>
<body>
  <header><h1>üçû Registrar Pedido - Panader√≠a</h1></header>
  <div class="card">
    <form id="formPedido">
      <input id="id_cliente" placeholder="ID Cliente" type="number" required>
      <input id="id_empleado" placeholder="ID Empleado" type="number" required>

      <h4>Agregar Producto</h4>
      <div>
        <input id="id_producto" placeholder="ID Producto" type="number">
        <input id="nombre_producto" placeholder="Nombre Producto" readonly>
      </div>
      <input id="cantidad" placeholder="Cantidad" type="number" min="1">

      <button type="button" onclick="agregar()">Agregar Detalle</button>
      <ul id="listaDetalles"></ul>

      <h4>Pago</h4>
      <select id="id_metodo_pago" required>
        <option value="1">Efectivo</option>
        <option value="2">Tarjeta</option>
        <option value="3">Transferencia</option>
      </select>

      <select id="id_estado_pago" required>
        <option value="1">Pendiente</option>
        <option value="2">Pagado</option>
      </select>

      <input id="monto_total" placeholder="Monto total" type="number" step="0.01" readonly>

      <button type="submit">Registrar Pedido</button>
      <p id="mensaje"></p>
    </form>
  </div>

  <script>
    let detalles = [];
    let total = 0;

    document.getElementById('id_producto').addEventListener('change', async function() {
      const idProducto = this.value;
      if (!idProducto) return;
      try {
        const res = await fetch(`/api/producto/${idProducto}`);
        const prod = await res.json();
        if (prod.error) { alert(prod.error); return; }
        document.getElementById('nombre_producto').value = prod.nombre;
      } catch (e) { alert('Error al obtener producto'); }
    });

    function agregar() {
      const id_producto = parseInt(document.getElementById('id_producto').value);
      const cantidad = parseInt(document.getElementById('cantidad').value);
      if (!id_producto || !cantidad) { alert("Completa todos los campos"); return; }

      detalles.push({ producto: { idProducto: id_producto }, cantidad });
      const item = document.createElement('li');
      item.textContent = `Producto ${id_producto}: Cantidad ${cantidad}`;
      document.getElementById('listaDetalles').appendChild(item);

      document.getElementById('id_producto').value = '';
      document.getElementById('cantidad').value = '';
    }

    document.getElementById('formPedido').addEventListener('submit', async e => {
      e.preventDefault();
      const id_cliente = parseInt(document.getElementById('id_cliente').value);
      const id_empleado = parseInt(document.getElementById('id_empleado').value);
      if (detalles.length === 0) { alert("Agrega al menos un producto"); return; }

      const pedido = { cliente: { idCliente: id_cliente }, empleado: { idEmpleado: id_empleado }, detalles };

      try {
        // üü¢ Registrar pedido
        const resPedido = await fetch('/api/pedido', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pedido)
        });
        const dataPedido = await resPedido.json();

        // üü¢ Registrar pago
        const pago = {
          id_pedido_cliente: dataPedido.id_pedido_cliente,
          id_metodo_pago: parseInt(document.getElementById('id_metodo_pago').value),
          id_estado_pago: parseInt(document.getElementById('id_estado_pago').value),
          monto: parseFloat(document.getElementById('monto_total').value || 0)
        };

        await fetch('/api/pago', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pago)
        });

        document.getElementById('mensaje').textContent = '‚úÖ Pedido y pago registrados correctamente';
        document.getElementById('formPedido').reset();
        document.getElementById('listaDetalles').innerHTML = '';
        detalles = [];

      } catch (err) {
        console.error(err);
        document.getElementById('mensaje').textContent = '‚ùå Error al registrar el pedido';
      }
    });
  </script>
</body>
</html>
